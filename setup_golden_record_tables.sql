-- ============================================
-- GOLDEN RECORD SCHEMA SETUP
-- Security Master Reference & History Tables
-- ============================================

USE ROLE ACCOUNTADMIN;
USE DATABASE SECURITIES_MASTER_DB;

-- Create Golden Record schema
CREATE SCHEMA IF NOT EXISTS GOLDEN_RECORD;
USE SCHEMA GOLDEN_RECORD;

-- ============================================
-- SECURITY_MASTER_REFERENCE TABLE
-- The authoritative golden record for securities
-- ============================================

CREATE OR REPLACE TABLE SECURITY_MASTER_REFERENCE (
    GLOBAL_SECURITY_ID VARCHAR(50) PRIMARY KEY,
    ISSUER VARCHAR(500) NOT NULL,
    ASSET_CLASS VARCHAR(50) NOT NULL,
    PRIMARY_TICKER VARCHAR(20),
    PRIMARY_EXCHANGE VARCHAR(50),
    ISIN VARCHAR(12),
    CUSIP VARCHAR(9),
    SEDOL VARCHAR(7),
    CURRENCY VARCHAR(3) NOT NULL,
    STATUS VARCHAR(20) DEFAULT 'ACTIVE',
    GOLDEN_SOURCE VARCHAR(200),
    LAST_VALIDATED TIMESTAMP_NTZ,
    LINEAGE_ID VARCHAR(100),
    CREATED_BY VARCHAR(100),
    CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    LAST_MODIFIED_BY VARCHAR(100),
    LAST_MODIFIED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

COMMENT ON TABLE SECURITY_MASTER_REFERENCE IS 'Golden record reference table for all securities - the single source of truth';
COMMENT ON COLUMN SECURITY_MASTER_REFERENCE.GLOBAL_SECURITY_ID IS 'Unique identifier in format GSID-XXXXXX';
COMMENT ON COLUMN SECURITY_MASTER_REFERENCE.LINEAGE_ID IS 'Data lineage tracking identifier';

-- ============================================
-- SECURITY_MASTER_HISTORY TABLE  
-- Full audit trail of all changes
-- ============================================

CREATE OR REPLACE TABLE SECURITY_MASTER_HISTORY (
    HISTORY_ID NUMBER AUTOINCREMENT PRIMARY KEY,
    GLOBAL_SECURITY_ID VARCHAR(50) NOT NULL,
    ACTION VARCHAR(20) NOT NULL,
    ISSUER_BEFORE VARCHAR(500),
    ISSUER_AFTER VARCHAR(500),
    ASSET_CLASS_BEFORE VARCHAR(50),
    ASSET_CLASS_AFTER VARCHAR(50),
    PRIMARY_TICKER_BEFORE VARCHAR(20),
    PRIMARY_TICKER_AFTER VARCHAR(20),
    PRIMARY_EXCHANGE_BEFORE VARCHAR(50),
    PRIMARY_EXCHANGE_AFTER VARCHAR(50),
    ISIN_BEFORE VARCHAR(12),
    ISIN_AFTER VARCHAR(12),
    CUSIP_BEFORE VARCHAR(9),
    CUSIP_AFTER VARCHAR(9),
    SEDOL_BEFORE VARCHAR(7),
    SEDOL_AFTER VARCHAR(7),
    CURRENCY_BEFORE VARCHAR(3),
    CURRENCY_AFTER VARCHAR(3),
    STATUS_BEFORE VARCHAR(20),
    STATUS_AFTER VARCHAR(20),
    EDIT_REASON VARCHAR(1000),
    CHANGED_BY VARCHAR(100),
    CHANGED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP(),
    SOURCE_SYSTEM VARCHAR(100),
    LINEAGE_ID VARCHAR(100),
    LINEAGE_PARENT_ID VARCHAR(100),
    LINEAGE_PATH VARCHAR(1000)
);

COMMENT ON TABLE SECURITY_MASTER_HISTORY IS 'Complete audit trail of all security master changes with full before/after state';
COMMENT ON COLUMN SECURITY_MASTER_HISTORY.ACTION IS 'Type of change: INSERT, UPDATE, DELETE';
COMMENT ON COLUMN SECURITY_MASTER_HISTORY.LINEAGE_PATH IS 'Full lineage chain showing data provenance';

-- ============================================
-- SEQUENCE FOR GLOBAL SECURITY IDS
-- ============================================

CREATE OR REPLACE SEQUENCE GSID_SEQ START = 100001 INCREMENT = 1;

-- ============================================
-- SAMPLE DATA - SECURITY_MASTER_REFERENCE
-- ============================================

INSERT INTO SECURITY_MASTER_REFERENCE 
(GLOBAL_SECURITY_ID, ISSUER, ASSET_CLASS, PRIMARY_TICKER, PRIMARY_EXCHANGE, ISIN, CUSIP, SEDOL, CURRENCY, STATUS, GOLDEN_SOURCE, LAST_VALIDATED, LINEAGE_ID, CREATED_BY, CREATED_AT, LAST_MODIFIED_BY)
VALUES
('GSID-000001', 'Apple Inc.', 'Equity', 'AAPL', 'NASDAQ', 'US0378331005', '037833100', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000001-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000002', 'Microsoft Corporation', 'Equity', 'MSFT', 'NASDAQ', 'US5949181045', '594918104', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000002-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000003', 'Amazon.com Inc.', 'Equity', 'AMZN', 'NASDAQ', 'US0231351067', '023135106', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000003-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000004', 'Alphabet Inc. Class A', 'Equity', 'GOOGL', 'NASDAQ', 'US02079K3059', '02079K305', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000004-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000005', 'NVIDIA Corporation', 'Equity', 'NVDA', 'NASDAQ', 'US67066G1040', '67066G104', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000005-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000006', 'Tesla Inc.', 'Equity', 'TSLA', 'NASDAQ', 'US88160R1014', '88160R101', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000006-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000007', 'Meta Platforms Inc.', 'Equity', 'META', 'NASDAQ', 'US30303M1027', '30303M102', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000007-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000008', 'Berkshire Hathaway Inc.', 'Equity', 'BRK.B', 'NYSE', 'US0846707026', '084670702', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000008-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000009', 'JPMorgan Chase & Co.', 'Equity', 'JPM', 'NYSE', 'US46625H1005', '46625H100', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000009-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000010', 'Johnson & Johnson', 'Equity', 'JNJ', 'NYSE', 'US4781601046', '478160104', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000010-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000011', 'Visa Inc.', 'Equity', 'V', 'NYSE', 'US92826C8394', '92826C839', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000011-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000012', 'UnitedHealth Group Inc.', 'Equity', 'UNH', 'NYSE', 'US91324P1021', '91324P102', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000012-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000013', 'HSBC Holdings plc', 'Equity', 'HSBA', 'LSE', 'GB0005405286', NULL, '0540528', 'GBP', 'ACTIVE', 'Refinitiv Eikon', CURRENT_TIMESTAMP(), 'LIN-GSID-000013-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000014', 'BP plc', 'Equity', 'BP.', 'LSE', 'GB0007980591', NULL, '0798059', 'GBP', 'ACTIVE', 'Refinitiv Eikon', CURRENT_TIMESTAMP(), 'LIN-GSID-000014-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000015', 'Shell plc', 'Equity', 'SHEL', 'LSE', 'GB00BP6MXD84', NULL, 'BP6MXD8', 'GBP', 'ACTIVE', 'Refinitiv Eikon', CURRENT_TIMESTAMP(), 'LIN-GSID-000015-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000016', 'AstraZeneca plc', 'Equity', 'AZN', 'LSE', 'GB0009895292', NULL, '0989529', 'GBP', 'ACTIVE', 'Refinitiv Eikon', CURRENT_TIMESTAMP(), 'LIN-GSID-000016-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000017', 'Unilever plc', 'Equity', 'ULVR', 'LSE', 'GB00B10RZP78', NULL, 'B10RZP7', 'GBP', 'ACTIVE', 'Refinitiv Eikon', CURRENT_TIMESTAMP(), 'LIN-GSID-000017-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000018', 'Rio Tinto plc', 'Equity', 'RIO', 'LSE', 'GB0007188757', NULL, '0718875', 'GBP', 'ACTIVE', 'Refinitiv Eikon', CURRENT_TIMESTAMP(), 'LIN-GSID-000018-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000019', 'Glencore plc', 'Equity', 'GLEN', 'LSE', 'JE00B4T3BW64', NULL, 'B4T3BW6', 'GBP', 'ACTIVE', 'Refinitiv Eikon', CURRENT_TIMESTAMP(), 'LIN-GSID-000019-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000020', 'Diageo plc', 'Equity', 'DGE', 'LSE', 'GB0002374006', NULL, '0237400', 'GBP', 'ACTIVE', 'Refinitiv Eikon', CURRENT_TIMESTAMP(), 'LIN-GSID-000020-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000021', 'US Treasury Bond 4.5% 2034', 'Fixed Income', 'T 4.5 02/15/34', 'OTC', 'US912810TM53', '912810TM5', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000021-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000022', 'US Treasury Bond 4.0% 2029', 'Fixed Income', 'T 4 11/15/29', 'OTC', 'US91282CJV63', '91282CJV6', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000022-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000023', 'Apple Inc. 3.85% 2043', 'Fixed Income', 'AAPL 3.85 05/04/43', 'OTC', 'US037833DU68', '037833DU6', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000023-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000024', 'Microsoft Corp 2.525% 2050', 'Fixed Income', 'MSFT 2.525 06/01/50', 'OTC', 'US594918CC45', '594918CC4', NULL, 'USD', 'ACTIVE', 'Bloomberg Terminal', CURRENT_TIMESTAMP(), 'LIN-GSID-000024-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM'),
('GSID-000025', 'UK Gilt 4.25% 2034', 'Fixed Income', 'UKT 4.25 12/07/34', 'LSE', 'GB00BMGR2916', NULL, 'BMGR291', 'GBP', 'ACTIVE', 'Refinitiv Eikon', CURRENT_TIMESTAMP(), 'LIN-GSID-000025-20260115120000', 'SYSTEM', '2026-01-15 12:00:00', 'SYSTEM');

-- ============================================
-- SAMPLE DATA - SECURITY_MASTER_HISTORY
-- ============================================

INSERT INTO SECURITY_MASTER_HISTORY 
(GLOBAL_SECURITY_ID, ACTION, ISSUER_BEFORE, ISSUER_AFTER, ASSET_CLASS_BEFORE, ASSET_CLASS_AFTER, PRIMARY_TICKER_BEFORE, PRIMARY_TICKER_AFTER, PRIMARY_EXCHANGE_BEFORE, PRIMARY_EXCHANGE_AFTER, ISIN_BEFORE, ISIN_AFTER, CUSIP_BEFORE, CUSIP_AFTER, SEDOL_BEFORE, SEDOL_AFTER, CURRENCY_BEFORE, CURRENCY_AFTER, STATUS_BEFORE, STATUS_AFTER, EDIT_REASON, CHANGED_BY, CHANGED_AT, SOURCE_SYSTEM, LINEAGE_ID, LINEAGE_PARENT_ID, LINEAGE_PATH)
VALUES
('GSID-000001', 'INSERT', NULL, 'Apple Inc.', NULL, 'Equity', NULL, 'AAPL', NULL, 'NASDAQ', NULL, 'US0378331005', NULL, '037833100', NULL, NULL, NULL, 'USD', NULL, 'ACTIVE', 'Initial security creation', 'SYSTEM', '2026-01-15 12:00:00', 'Security Master EDM', 'LIN-GSID-000001-20260115120000', NULL, 'LIN-GSID-000001-20260115120000'),
('GSID-000002', 'INSERT', NULL, 'Microsoft Corporation', NULL, 'Equity', NULL, 'MSFT', NULL, 'NASDAQ', NULL, 'US5949181045', NULL, '594918104', NULL, NULL, NULL, 'USD', NULL, 'ACTIVE', 'Initial security creation', 'SYSTEM', '2026-01-15 12:00:00', 'Security Master EDM', 'LIN-GSID-000002-20260115120000', NULL, 'LIN-GSID-000002-20260115120000'),
('GSID-000003', 'INSERT', NULL, 'Amazon.com Inc.', NULL, 'Equity', NULL, 'AMZN', NULL, 'NASDAQ', NULL, 'US0231351067', NULL, '023135106', NULL, NULL, NULL, 'USD', NULL, 'ACTIVE', 'Initial security creation', 'SYSTEM', '2026-01-15 12:00:00', 'Security Master EDM', 'LIN-GSID-000003-20260115120000', NULL, 'LIN-GSID-000003-20260115120000'),
('GSID-000004', 'INSERT', NULL, 'Alphabet Inc. Class A', NULL, 'Equity', NULL, 'GOOGL', NULL, 'NASDAQ', NULL, 'US02079K3059', NULL, '02079K305', NULL, NULL, NULL, 'USD', NULL, 'ACTIVE', 'Initial security creation', 'SYSTEM', '2026-01-15 12:00:00', 'Security Master EDM', 'LIN-GSID-000004-20260115120000', NULL, 'LIN-GSID-000004-20260115120000'),
('GSID-000005', 'INSERT', NULL, 'NVIDIA Corporation', NULL, 'Equity', NULL, 'NVDA', NULL, 'NASDAQ', NULL, 'US67066G1040', NULL, '67066G104', NULL, NULL, NULL, 'USD', NULL, 'ACTIVE', 'Initial security creation', 'SYSTEM', '2026-01-15 12:00:00', 'Security Master EDM', 'LIN-GSID-000005-20260115120000', NULL, 'LIN-GSID-000005-20260115120000'),
('GSID-000006', 'INSERT', NULL, 'Tesla Inc.', NULL, 'Equity', NULL, 'TSLA', NULL, 'NASDAQ', NULL, 'US88160R1014', NULL, '88160R101', NULL, NULL, NULL, 'USD', NULL, 'ACTIVE', 'Initial security creation', 'SYSTEM', '2026-01-15 12:00:00', 'Security Master EDM', 'LIN-GSID-000006-20260115120000', NULL, 'LIN-GSID-000006-20260115120000'),
('GSID-000007', 'INSERT', NULL, 'Meta Platforms Inc.', NULL, 'Equity', NULL, 'META', NULL, 'NASDAQ', NULL, 'US30303M1027', NULL, '30303M102', NULL, NULL, NULL, 'USD', NULL, 'ACTIVE', 'Initial security creation', 'SYSTEM', '2026-01-15 12:00:00', 'Security Master EDM', 'LIN-GSID-000007-20260115120000', NULL, 'LIN-GSID-000007-20260115120000'),
('GSID-000007', 'UPDATE', 'Facebook Inc.', 'Meta Platforms Inc.', 'Equity', 'Equity', 'FB', 'META', 'NASDAQ', 'NASDAQ', 'US30303M1027', 'US30303M1027', '30303M102', '30303M102', NULL, NULL, 'USD', 'USD', 'ACTIVE', 'ACTIVE', 'Corporate rebranding from Facebook to Meta Platforms', 'ADMIN', '2026-01-16 09:30:00', 'Security Master EDM', 'LIN-GSID-000007-20260116093000', 'LIN-GSID-000007-20260115120000', 'LIN-GSID-000007-20260115120000 -> LIN-GSID-000007-20260116093000'),
('GSID-000013', 'INSERT', NULL, 'HSBC Holdings plc', NULL, 'Equity', NULL, 'HSBA', NULL, 'LSE', NULL, 'GB0005405286', NULL, NULL, NULL, '0540528', NULL, 'GBP', NULL, 'ACTIVE', 'Initial security creation - LSEG feed', 'SYSTEM', '2026-01-15 12:00:00', 'Security Master EDM', 'LIN-GSID-000013-20260115120000', NULL, 'LIN-GSID-000013-20260115120000'),
('GSID-000021', 'INSERT', NULL, 'US Treasury Bond 4.5% 2034', NULL, 'Fixed Income', NULL, 'T 4.5 02/15/34', NULL, 'OTC', NULL, 'US912810TM53', NULL, '912810TM5', NULL, NULL, NULL, 'USD', NULL, 'ACTIVE', 'New Treasury issuance', 'SYSTEM', '2026-01-15 12:00:00', 'Security Master EDM', 'LIN-GSID-000021-20260115120000', NULL, 'LIN-GSID-000021-20260115120000');

-- ============================================
-- INDEXES FOR PERFORMANCE
-- ============================================

CREATE OR REPLACE INDEX IDX_REF_ISIN ON SECURITY_MASTER_REFERENCE(ISIN);
CREATE OR REPLACE INDEX IDX_REF_CUSIP ON SECURITY_MASTER_REFERENCE(CUSIP);
CREATE OR REPLACE INDEX IDX_REF_SEDOL ON SECURITY_MASTER_REFERENCE(SEDOL);
CREATE OR REPLACE INDEX IDX_REF_TICKER ON SECURITY_MASTER_REFERENCE(PRIMARY_TICKER);
CREATE OR REPLACE INDEX IDX_HIST_GSID ON SECURITY_MASTER_HISTORY(GLOBAL_SECURITY_ID);
CREATE OR REPLACE INDEX IDX_HIST_CHANGED_AT ON SECURITY_MASTER_HISTORY(CHANGED_AT);

-- ============================================
-- VERIFICATION
-- ============================================

SELECT 'SECURITY_MASTER_REFERENCE' AS TABLE_NAME, COUNT(*) AS ROW_COUNT FROM SECURITY_MASTER_REFERENCE
UNION ALL
SELECT 'SECURITY_MASTER_HISTORY', COUNT(*) FROM SECURITY_MASTER_HISTORY;
